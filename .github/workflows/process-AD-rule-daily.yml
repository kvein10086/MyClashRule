name: Process AWAvenue Ads Rule Daily

on:
  schedule:
    - cron: '0 16 * * *' # æ¯å¤©çš„åŒ—äº¬æ—¶é—´ 00:00 è¿è¡Œä¸€æ¬¡ (UTC+8 è½¬ UTC ä¸º 16:00)
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘å·¥ä½œæµ

jobs:
  process-rule:
    runs-on: ubuntu-latest  # é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„è™šæ‹Ÿç¯å¢ƒ

    steps:
      - name: Checkout code
        uses: actions/checkout@v3  # æ‹‰å–ä»£ç ä»“åº“ä¸­çš„æ–‡ä»¶

      - name: Download AWAvenue-Ads-Rule-Clash.yaml
        run: |
          # æ·»åŠ é”™è¯¯å¤„ç†
          if ! curl -o AWAvenue-Ads-Rule-Clash.yaml https://raw.githubusercontent.com/TG-Twilight/AWAvenue-Ads-Rule/main/Filters/AWAvenue-Ads-Rule-Clash.yaml; then
            echo "ä¸‹è½½è§„åˆ™æ–‡ä»¶å¤±è´¥"
            exit 1
          fi

      - name: Process the file
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          mkdir -p temp
          
          # å¤„ç†æ–‡ä»¶å¹¶æ·»åŠ é”™è¯¯æ£€æŸ¥
          if ! sed "s/- '/DOMAIN-SUFFIX,/g" AWAvenue-Ads-Rule-Clash.yaml | sed "s/'//g" > temp/temp.list; then
            echo "å¤„ç†æ–‡ä»¶å¤±è´¥"
            exit 1
          fi
          
          sed -n '/DOMAIN-SUFFIX/,$p' temp/temp.list > temp/temp2.list
          sed 's/^ *//' temp/temp2.list > Rule/AWAvenue-Ads-Rule.list
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ ! -s Rule/AWAvenue-Ads-Rule.list ]; then
            echo "ç”Ÿæˆè§„åˆ™æ–‡ä»¶å¤±è´¥"
            exit 1
          fi

      - name: Compare files
        id: compare
        run: |
          if [ -f "Rule/AWAvenue-Ads-Rule.list" ]; then
            if git show HEAD:Rule/AWAvenue-Ads-Rule.list > temp/old_list.txt 2>/dev/null; then
              diff --unchanged-line-format='' --old-line-format='- %L' --new-line-format='+ %L' temp/old_list.txt Rule/AWAvenue-Ads-Rule.list > temp/diff_output.txt || true
            else
              echo "é¦–æ¬¡ç”Ÿæˆè§„åˆ™æ–‡ä»¶" > temp/diff_output.txt
            fi
          else
            echo "è§„åˆ™æ–‡ä»¶ä¸å­˜åœ¨" > temp/diff_output.txt
          fi

          if [ ! -s temp/diff_output.txt ]; then
            echo "æ–‡ä»¶æ²¡æœ‰å˜æ›´ã€‚" > temp/diff_output.txt
            echo "status=no-change" >> $GITHUB_OUTPUT
          else
            echo "status=change" >> $GITHUB_OUTPUT
          fi

      - name: Update README.md
        if: steps.compare.outputs.status == 'change'
        run: |
          # ä½¿ç”¨æ›´å®‰å…¨çš„æ—¥å¿—æ›´æ–°æ–¹å¼
          LOG_DATE=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
          DIFF_CONTENT=$(cat temp/diff_output.txt)
          
          # åˆ›å»ºæ–°çš„æ—¥å¿—å†…å®¹
          echo -e "### ${LOG_DATE}\n\n\`\`\`diff\n${DIFF_CONTENT}\n\`\`\`\n" > temp/new_log.txt
          
          # æå–READMEä¸­æ—¥å¿—éƒ¨åˆ†ä¹‹å‰çš„å†…å®¹
          sed -n '1,/^## å¹¿å‘Šè§„åˆ™æ›´æ–°æ—¥å¿—$/p' README.md > temp/readme_header.txt
          
          # æå–ç°æœ‰çš„ç¬¬ä¸€æ¡æ—¥å¿—ï¼ˆæœ€è¿‘çš„ä¸€æ¡ï¼‰
          awk '
            BEGIN { in_log=0; log_count=0; current_entry="" }
            /^## å¹¿å‘Šè§„åˆ™æ›´æ–°æ—¥å¿—/ { in_log=1; next }
            /^##/ && in_log { exit }
            in_log && /^### / { 
              if (log_count == 0) {
                current_entry = $0 "\n"
                log_count++
              } else if (log_count == 1) {
                print current_entry
                exit
              }
              next
            }
            in_log && log_count == 1 { current_entry = current_entry $0 "\n" }
          ' README.md > temp/recent_log.txt
          
          # æå–æ‰€æœ‰å†å²æ—¥å¿—ï¼ˆç¬¬2æ¡åŠä»¥åçš„æ‰€æœ‰æ—¥å¿—ï¼‰
          awk '
            BEGIN { in_log=0; log_count=0; in_history=0 }
            /^## å¹¿å‘Šè§„åˆ™æ›´æ–°æ—¥å¿—/ { in_log=1; next }
            /^##/ && in_log { exit }
            in_log && /^### / { 
              log_count++
              if (log_count >= 2) {
                in_history = 1
              }
            }
            in_log && in_history { print }
          ' README.md > temp/history_logs.txt
          
          # æå–æ—¥å¿—éƒ¨åˆ†ä¹‹åçš„å†…å®¹
          awk '
            BEGIN { in_log=0; after_log=0 }
            /^## å¹¿å‘Šè§„åˆ™æ›´æ–°æ—¥å¿—/ { in_log=1; next }
            /^##/ && in_log { after_log=1; in_log=0 }
            after_log { print }
          ' README.md > temp/readme_footer.txt
          
          # é‡æ–°æ„å»º README.md
          cat temp/readme_header.txt > temp/README.new
          echo "" >> temp/README.new
          
          # æ·»åŠ æ–°æ—¥å¿—
          cat temp/new_log.txt >> temp/README.new
          
          # æ·»åŠ æœ€è¿‘ä¸€æ¡å†å²æ—¥å¿—
          if [ -s temp/recent_log.txt ]; then
            cat temp/recent_log.txt >> temp/README.new
          fi
          
          # æ·»åŠ æŠ˜å çš„å†å²æ—¥å¿—
          if [ -s temp/history_logs.txt ]; then
            echo "<details>" >> temp/README.new
            echo "<summary>ğŸ“‹ æŸ¥çœ‹å†å²æ›´æ–°æ—¥å¿—</summary>" >> temp/README.new
            echo "" >> temp/README.new
            cat temp/history_logs.txt >> temp/README.new
            echo "</details>" >> temp/README.new
            echo "" >> temp/README.new
          fi
          
          # æ·»åŠ æ—¥å¿—éƒ¨åˆ†ä¹‹åçš„å†…å®¹
          if [ -s temp/readme_footer.txt ]; then
            cat temp/readme_footer.txt >> temp/README.new
          fi
          
          mv temp/README.new README.md

      - name: Commit and push changes
        if: steps.compare.outputs.status == 'change'
        env:
          PAT: ${{ secrets.PAT }}
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ä¿å­˜å½“å‰çš„æ›´æ”¹
          git stash
          
          # è·å–æœ€æ–°çš„è¿œç¨‹æ›´æ”¹
          git fetch origin main
          
          # åˆ‡æ¢åˆ° main åˆ†æ”¯
          git checkout main
          
          # é‡ç½®åˆ°è¿œç¨‹çŠ¶æ€
          git reset --hard origin/main
          
          # åº”ç”¨ä¹‹å‰ä¿å­˜çš„æ›´æ”¹
          git stash pop
          
          # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
          git add Rule/AWAvenue-Ads-Rule.list README.md
          git commit -m "æ›´æ–°å¹¿å‘Šæ‹¦æˆªè§„åˆ™æ–‡ä»¶å’Œæœ€æ–°æ—¥å¿—"
          
          # æ·»åŠ é‡è¯•æœºåˆ¶
          for i in {1..3}; do
            if git push https://x-access-token:${{ secrets.PAT }}@github.com/kvein10086/MyClashRule.git HEAD:main; then
              echo "æˆåŠŸæ¨é€æ›´æ”¹"
              break
            fi
            if [ $i -eq 3 ]; then
              echo "æ¨é€æ›´æ”¹å¤±è´¥"
              exit 1
            fi
            echo "ç¬¬ $i æ¬¡æ¨é€å¤±è´¥ï¼Œç­‰å¾… 5 ç§’åé‡è¯•..."
            sleep 5
          done

      - name: Cleanup
        if: always()
        run: |
          rm -rf temp
